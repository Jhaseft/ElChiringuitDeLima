import{r as t,j as e,a as V}from"./app-CYhPuoS9.js";import{S as J,D as K,a as P,b as q}from"./StepVideo-CLBw6WYo.js";import{L as A}from"./refresh-cw-zClI_aBZ.js";import"./createLucideIcon-wjZsnj5p.js";function z({docType:r,docFrontBlob:o,docBackBlob:a,videoBlob:c,prevStep:b,loading:f,setLoading:j,resultado:l,setResultado:y,onResultToApp:N}){const[S,d]=t.useState(null),[R,g]=t.useState([]),[h,v]=t.useState(null),[u,m]=t.useState(null),[D,_]=t.useState(null),[L,k]=t.useState(!1),[w,C]=t.useState(!1),[U,O]=t.useState(!1);t.useEffect(()=>{let s,n,p;return o&&(s=URL.createObjectURL(o)),a&&(n=URL.createObjectURL(a)),c&&(p=URL.createObjectURL(c)),v(s||null),m(n||null),_(p||null),k(!1),C(!1),O(!1),()=>{s&&URL.revokeObjectURL(s),n&&URL.revokeObjectURL(n),p&&URL.revokeObjectURL(p)}},[o,a,c]);const E=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",M=async()=>{if(!o||!c){alert("‚ö†Ô∏è Debes capturar al menos documento frontal y video.");return}if((r==="ci"||r==="licencia")&&!a){alert("‚ö†Ô∏è Debes capturar tambi√©n el reverso.");return}if(!(L&&(!a||w)&&U)){alert("‚ö†Ô∏è Espera a que todos los recursos se carguen completamente.");return}try{j(!0),d(null),g([]);const s=new FormData;s.append("carnet",o,"documento_frente.jpg"),a&&s.append("carnet_back",a,"documento_reverso.jpg"),s.append("doc_type",r),s.append("video",c,"video.mp4");const n=await V.post("/kyc-proxy-mobile",s,{headers:{"Content-Type":"multipart/form-data"}});y(n.data);const p=E(),x=new FormData;x.append("doc_type",r),x.append("docFront",o,"documento_frente.jpg"),a&&x.append("docBack",a,"documento_reverso.jpg"),x.append("video",c,"video.mp4"),x.append("resultado",JSON.stringify(n.data));const i=(await V.post("/mobile-face-verify",x,{headers:{"X-CSRF-TOKEN":p}})).data;d(i.mensaje||"‚ÑπÔ∏è Verificaci√≥n realizada."),g(i.sugerencias||[]),N&&(i.status==="success"||i.kyc_status==="active")&&N({status:i.status||i.kyc_status,mensaje:i.mensaje,sugerencias:i.sugerencias,kyc:n.data})}catch(s){console.error("‚ùå Error en verificaci√≥n:",s),s.response?.status===422?(d("‚ö†Ô∏è Datos inv√°lidos: revisa los campos requeridos."),g(s.response.data?.errors||[])):s.response?.data?.mensaje?d("‚ùå "+s.response.data.mensaje):d("‚ùå Error inesperado en la verificaci√≥n KYC.")}finally{j(!1)}},F=()=>l?e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-gray-100 shadow-inner space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Resultado de verificaci√≥n"}),S&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"üì¢ Mensaje:"})," ",S]}),l.score!==void 0&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"‚≠ê Score:"})," ",l.score]}),R.length>0&&e.jsxs("div",{children:[e.jsx("strong",{className:"text-sm",children:"‚ö†Ô∏è Sugerencias:"}),e.jsx("ul",{className:"list-disc ml-5 text-sm text-red-600",children:R.map((s,n)=>e.jsx("li",{children:s},`problem-${n}`))})]}),e.jsxs("details",{className:"mt-3",children:[e.jsx("summary",{className:"cursor-pointer text-xs text-gray-500",children:"Ver JSON completo"}),e.jsx("pre",{className:"text-xs bg-white rounded-md p-2 overflow-auto max-h-60 border",children:JSON.stringify(l,null,2)},JSON.stringify(l))]})]}):null;return e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 space-y-4",children:[e.jsx("p",{className:"font-semibold text-lg text-center",children:"Revisa tus capturas"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[h&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:r==="pasaporte"?"Pasaporte":"Anverso"}),e.jsx("img",{src:h,alt:"Documento anverso",onLoad:()=>k(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),u&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Reverso"}),e.jsx("img",{src:u,alt:"Documento reverso",onLoad:()=>C(!0),className:"rounded-lg border shadow w-full h-auto object-cover opacity-80"})]})]}),D&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Video selfie"}),e.jsx("video",{src:D,controls:!0,onLoadedData:()=>O(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),!L||a&&!w||!U?e.jsx("p",{className:"text-center text-sm text-gray-500 mt-2",children:"‚è≥ Cargando recursos..."}):null,e.jsxs("div",{className:"flex flex-wrap justify-center gap-3 mt-4",children:[e.jsx("button",{onClick:b,className:"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg",children:"Atr√°s"}),e.jsxs("button",{onClick:M,disabled:f||!(L&&(!a||w)&&U),className:"bg-purple-600 hover:bg-purple-700 disabled:opacity-60 text-white px-4 py-2 rounded-lg flex items-center gap-2",children:[f&&e.jsx(A,{className:"h-4 w-4 animate-spin"})," Verificar"]})]}),F()]})}function H(){const[r,o]=t.useState(1),[a,c]=t.useState("ci"),[b,f]=t.useState(null),[j,l]=t.useState(null),[y,N]=t.useState(null),[S,d]=t.useState(!1),[R,g]=t.useState(null),h=4,v=()=>o(m=>Math.min(m+1,h)),u=()=>{o(m=>(m===2&&(f(null),l(null)),Math.max(m-1,1)))};return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-indigo-50 to-purple-50 space-y-6",children:e.jsxs("div",{className:"w-full max-w-3xl",children:[e.jsx(J,{step:r,totalSteps:h,labels:["Documento","Captura","Video","Revisi√≥n"]}),r===1&&e.jsx(K,{value:a,onChange:c,onNext:v}),r===2&&e.jsx(P,{docType:a,docFrontBlob:b,docBackBlob:j,setDocFrontBlob:f,setDocBackBlob:l,onNext:v,onBack:u}),r===3&&e.jsx(q,{videoBlob:y,setVideoBlob:N,nextStep:v,prevStep:u}),r===4&&e.jsx(z,{docType:a,docFrontBlob:b,docBackBlob:j,videoBlob:y,prevStep:u,loading:S,setLoading:d,resultado:R,setResultado:g})]})})}export{H as default};
