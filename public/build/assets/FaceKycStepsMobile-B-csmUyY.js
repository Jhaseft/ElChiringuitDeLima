import{r as t,j as e,a as _}from"./app-Dfij3uMP.js";import{S as A,D as T,a as z,b as G}from"./StepVideo-DUOhDwrk.js";import{L as I}from"./refresh-cw-DKpOubc9.js";import"./createLucideIcon-BGpu7eFA.js";function X({docType:r,docFrontBlob:o,docBackBlob:a,videoBlob:c,prevStep:b,loading:m,setLoading:j,resultado:l,setResultado:y,onResultToApp:N}){const[S,d]=t.useState(null),[R,h]=t.useState([]),[g,v]=t.useState(null),[p,x]=t.useState(null),[U,P]=t.useState(null),[w,D]=t.useState(!1),[L,C]=t.useState(!1),[k,V]=t.useState(!1),[E,M]=t.useState(!1);t.useEffect(()=>{let s,n,f;return o&&(s=URL.createObjectURL(o)),a&&(n=URL.createObjectURL(a)),c&&(f=URL.createObjectURL(c)),v(s||null),x(n||null),P(f||null),D(!1),C(!1),V(!1),()=>{s&&URL.revokeObjectURL(s),n&&URL.revokeObjectURL(n),f&&URL.revokeObjectURL(f)}},[o,a,c]);const F=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",J=async()=>{if(!o||!c){alert("‚ö†Ô∏è Debes capturar al menos documento frontal y video.");return}if((r==="ci"||r==="licencia")&&!a){alert("‚ö†Ô∏è Debes capturar tambi√©n el reverso.");return}if(!(w&&(!a||L)&&k)){alert("‚ö†Ô∏è Espera a que todos los recursos se carguen completamente.");return}try{j(!0),d(null),h([]);const s=new FormData;s.append("carnet",o,"documento_frente.jpg"),a&&s.append("carnet_back",a,"documento_reverso.jpg"),s.append("doc_type",r),s.append("video",c,"video.mp4");const n=await _.post("/kyc-proxy-mobile",s,{headers:{"Content-Type":"multipart/form-data"}});y(n.data);const f=F(),u=new FormData;u.append("doc_type",r),u.append("docFront",o,"documento_frente.jpg"),a&&u.append("docBack",a,"documento_reverso.jpg"),u.append("video",c,"video.mp4"),u.append("resultado",JSON.stringify(n.data));const O=new URLSearchParams(window.location.search).get("token");O&&u.append("token",O);const i=(await _.post("/mobile-face-verify",u,{headers:{"X-CSRF-TOKEN":f}})).data;d(i.mensaje||"‚ÑπÔ∏èVerificaci√≥n realizada porfavor vuelve ala App."),h(i.sugerencias||[]),N&&(i.status==="success"||i.kyc_status==="active")&&(N({status:i.status||i.kyc_status,mensaje:i.mensaje,sugerencias:i.sugerencias,kyc:n.data}),M(!0),setTimeout(()=>{try{window.close()}catch(q){console.error("No se pudo cerrar la ventana autom√°ticamente",q)}},500))}catch(s){console.error("‚ùå Error en verificaci√≥n:",s),s.response?.status===422?(d("‚ö†Ô∏è Datos inv√°lidos: revisa los campos requeridos."),h(s.response.data?.errors||[])):s.response?.data?.mensaje?d("‚ùå "+s.response.data.mensaje):d("‚ùå Error inesperado en la verificaci√≥n KYC.")}finally{j(!1)}};if(E)return e.jsxs("div",{className:"fixed inset-0 bg-green-600 text-white flex flex-col items-center justify-center p-4 text-center",children:[e.jsx("h1",{className:"text-4xl font-bold mb-4",children:"‚úÖ Identidad Verificada"}),e.jsx("p",{className:"text-xl",children:"Gracias por completar la verificaci√≥n. Por seguridad, cierra esta ventana y vuelve a la app."})]});const K=()=>l?e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-gray-100 shadow-inner space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Resultado de verificaci√≥n"}),S&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"üì¢ Mensaje:"})," ",S]}),l.score!==void 0&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"‚≠ê Score:"})," ",l.score]}),R.length>0&&e.jsxs("div",{children:[e.jsx("strong",{className:"text-sm",children:"‚ö†Ô∏è Sugerencias:"}),e.jsx("ul",{className:"list-disc ml-5 text-sm text-red-600",children:R.map((s,n)=>e.jsx("li",{children:s},`problem-${n}`))})]}),e.jsxs("details",{className:"mt-3",children:[e.jsx("summary",{className:"cursor-pointer text-xs text-gray-500",children:"Ver JSON completo"}),e.jsx("pre",{className:"text-xs bg-white rounded-md p-2 overflow-auto max-h-60 border",children:JSON.stringify(l,null,2)},JSON.stringify(l))]})]}):null;return e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 space-y-4",children:[e.jsx("p",{className:"font-semibold text-lg text-center",children:"Revisa tus capturas"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[g&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:r==="pasaporte"?"Pasaporte":"Anverso"}),e.jsx("img",{src:g,alt:"Documento anverso",onLoad:()=>D(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),p&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Reverso"}),e.jsx("img",{src:p,alt:"Documento reverso",onLoad:()=>C(!0),className:"rounded-lg border shadow w-full h-auto object-cover opacity-80"})]})]}),U&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Video selfie"}),e.jsx("video",{src:U,controls:!0,onLoadedData:()=>V(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),!w||a&&!L||!k?e.jsx("p",{className:"text-center text-sm text-gray-500 mt-2",children:"‚è≥ Cargando recursos..."}):null,e.jsxs("div",{className:"flex flex-wrap justify-center gap-3 mt-4",children:[e.jsx("button",{onClick:b,disabled:m,className:"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg",children:"Atr√°s"}),e.jsxs("button",{onClick:J,disabled:m||!(w&&(!a||L)&&k),className:"bg-purple-600 hover:bg-purple-700 disabled:opacity-60 text-white px-4 py-2 rounded-lg flex items-center gap-2",children:[m&&e.jsx(I,{className:"h-4 w-4 animate-spin"})," Verificar"]})]}),K()]})}function B(){const[r,o]=t.useState(1),[a,c]=t.useState("ci"),[b,m]=t.useState(null),[j,l]=t.useState(null),[y,N]=t.useState(null),[S,d]=t.useState(!1),[R,h]=t.useState(null),g=4,v=()=>o(x=>Math.min(x+1,g)),p=()=>{o(x=>(x===2&&(m(null),l(null)),Math.max(x-1,1)))};return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-indigo-50 to-purple-50 space-y-6",children:e.jsxs("div",{className:"w-full max-w-3xl",children:[e.jsx(A,{step:r,totalSteps:g,labels:["Documento","Captura","Video","Revisi√≥n"]}),r===1&&e.jsx(T,{value:a,onChange:c,onNext:v}),r===2&&e.jsx(z,{docType:a,docFrontBlob:b,docBackBlob:j,setDocFrontBlob:m,setDocBackBlob:l,onNext:v,onBack:p}),r===3&&e.jsx(G,{videoBlob:y,setVideoBlob:N,nextStep:v,prevStep:p}),r===4&&e.jsx(X,{docType:a,docFrontBlob:b,docBackBlob:j,videoBlob:y,prevStep:p,loading:S,setLoading:d,resultado:R,setResultado:h})]})})}export{B as default};
