import{r as t,j as e,a as O}from"./app-BV7qdRFB.js";import{S as J,D as K,a as M,b as q}from"./StepVideo-BDSQEHJG.js";import{L as A}from"./refresh-cw-Ct13D_bR.js";import"./createLucideIcon-3EdIiZOl.js";function T({docType:r,docFrontBlob:n,docBackBlob:a,videoBlob:c,prevStep:g,loading:x,setLoading:f,resultado:l,setResultado:v}){const[S,i]=t.useState(null),[b,j]=t.useState([]),[N,y]=t.useState(null),[u,h]=t.useState(null),[d,V]=t.useState(null),[w,D]=t.useState(!1),[L,k]=t.useState(!1),[U,C]=t.useState(!1);t.useEffect(()=>{let s,o,m;return n&&(s=URL.createObjectURL(n)),a&&(o=URL.createObjectURL(a)),c&&(m=URL.createObjectURL(c)),y(s||null),h(o||null),V(m||null),D(!1),k(!1),C(!1),()=>{s&&URL.revokeObjectURL(s),o&&URL.revokeObjectURL(o),m&&URL.revokeObjectURL(m)}},[n,a,c]);const _=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",E=async()=>{if(!n||!c){alert("‚ö†Ô∏è Debes capturar al menos documento frontal y video.");return}if((r==="ci"||r==="licencia")&&!a){alert("‚ö†Ô∏è Debes capturar tambi√©n el reverso.");return}if(!(w&&(!a||L)&&U)){alert("‚ö†Ô∏è Espera a que todos los recursos se carguen completamente.");return}try{f(!0),i(null),j([]);const s=new FormData;s.append("carnet",n,"documento_frente.jpg"),a&&s.append("carnet_back",a,"documento_reverso.jpg"),s.append("doc_type",r),s.append("video",c,"video.mp4");const o=await O.post("/kyc-proxy",s,{headers:{"Content-Type":"multipart/form-data"}});v(o.data);const m=_(),p=new FormData;p.append("doc_type",r),p.append("docFront",n,"documento_frente.jpg"),a&&p.append("docBack",a,"documento_reverso.jpg"),p.append("video",c,"video.mp4"),p.append("resultado",JSON.stringify(o.data));const R=(await O.post("/face/verify",p,{headers:{"X-CSRF-TOKEN":m}})).data;i(R.mensaje||"‚ÑπÔ∏è Verificaci√≥n realizada."),j(R.sugerencias||[]),(R.status==="success"||R.kyc_status==="active")&&setTimeout(()=>{const P=new URLSearchParams(window.location.search).get("next");window.location.href=P||"/"},1500)}catch(s){console.error("‚ùå Error en verificaci√≥n:",s),s.response?.status===422?(i("‚ö†Ô∏è Datos inv√°lidos: revisa los campos requeridos."),j(s.response.data?.errors||[])):s.response?.data?.mensaje?i("‚ùå "+s.response.data.mensaje):i("‚ùå Error inesperado en la verificaci√≥n KYC.")}finally{f(!1)}},F=()=>l?e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-gray-100 shadow-inner space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Resultado de verificaci√≥n"}),S&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"üì¢ Mensaje:"})," ",S]}),l.score!==void 0&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"‚≠ê Score:"})," ",l.score]}),b.length>0&&e.jsxs("div",{children:[e.jsx("strong",{className:"text-sm",children:"‚ö†Ô∏è Sugerencias:"}),e.jsx("ul",{className:"list-disc ml-5 text-sm text-red-600",children:b.map((s,o)=>e.jsx("li",{children:s},`problem-${o}`))})]}),e.jsxs("details",{className:"mt-3",children:[e.jsx("summary",{className:"cursor-pointer text-xs text-gray-500",children:"Ver JSON completo"}),e.jsx("pre",{className:"text-xs bg-white rounded-md p-2 overflow-auto max-h-60 border",children:JSON.stringify(l,null,2)},JSON.stringify(l))]})]}):null;return e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 space-y-4",children:[e.jsx("p",{className:"font-semibold text-lg text-center",children:"Revisa tus capturas"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[N&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:r==="pasaporte"?"Pasaporte":"Anverso"}),e.jsx("img",{src:N,alt:"Documento anverso",onLoad:()=>D(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),u&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Reverso"}),e.jsx("img",{src:u,alt:"Documento reverso",onLoad:()=>k(!0),className:"rounded-lg border shadow w-full h-auto object-cover opacity-80"})]})]}),d&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Video selfie"}),e.jsx("video",{src:d,controls:!0,onLoadedData:()=>C(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),!w||a&&!L||!U?e.jsx("p",{className:"text-center text-sm text-gray-500 mt-2",children:"‚è≥ Cargando recursos..."}):null,e.jsxs("div",{className:"flex flex-wrap justify-center gap-3 mt-4",children:[e.jsx("button",{onClick:g,className:"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg",children:"Atr√°s"}),e.jsxs("button",{onClick:E,disabled:x||!(w&&(!a||L)&&U),className:"bg-purple-600 hover:bg-purple-700 disabled:opacity-60 text-white px-4 py-2 rounded-lg flex items-center gap-2",children:[x&&e.jsx(A,{className:"h-4 w-4 animate-spin"})," Verificar"]})]}),F()]})}function I(){const[r,n]=t.useState(1),[a,c]=t.useState("ci"),[g,x]=t.useState(null),[f,l]=t.useState(null),[v,S]=t.useState(null),[i,b]=t.useState(!1),[j,N]=t.useState(null),y=4,u=()=>n(d=>Math.min(d+1,y)),h=()=>{n(d=>(d===2&&(x(null),l(null)),Math.max(d-1,1)))};return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-indigo-50 to-purple-50 space-y-6",children:e.jsxs("div",{className:"w-full max-w-3xl",children:[e.jsx(J,{step:r,totalSteps:y,labels:["Documento","Captura","Video","Revisi√≥n"]}),r===1&&e.jsx(K,{value:a,onChange:c,onNext:u}),r===2&&e.jsx(M,{docType:a,docFrontBlob:g,docBackBlob:f,setDocFrontBlob:x,setDocBackBlob:l,onNext:u,onBack:h}),r===3&&e.jsx(q,{videoBlob:v,setVideoBlob:S,nextStep:u,prevStep:h}),r===4&&e.jsx(T,{docType:a,docFrontBlob:g,docBackBlob:f,videoBlob:v,prevStep:h,loading:i,setLoading:b,resultado:j,setResultado:N})]})})}export{I as default};
