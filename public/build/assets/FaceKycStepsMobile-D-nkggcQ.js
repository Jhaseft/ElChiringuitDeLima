import{r as t,j as e,a as _}from"./app-C4609MBV.js";import{S as J,D as K,a as q,b as A}from"./StepVideo-U6CEarGo.js";import{L as T}from"./refresh-cw-DloHQ9kS.js";import"./createLucideIcon-ECSM6UEe.js";function z({docType:r,docFrontBlob:o,docBackBlob:a,videoBlob:c,prevStep:b,loading:f,setLoading:j,resultado:l,setResultado:y,onResultToApp:S}){const[N,d]=t.useState(null),[R,g]=t.useState([]),[h,v]=t.useState(null),[m,p]=t.useState(null),[U,P]=t.useState(null),[w,D]=t.useState(!1),[L,C]=t.useState(!1),[k,O]=t.useState(!1);t.useEffect(()=>{let s,n,x;return o&&(s=URL.createObjectURL(o)),a&&(n=URL.createObjectURL(a)),c&&(x=URL.createObjectURL(c)),v(s||null),p(n||null),P(x||null),D(!1),C(!1),O(!1),()=>{s&&URL.revokeObjectURL(s),n&&URL.revokeObjectURL(n),x&&URL.revokeObjectURL(x)}},[o,a,c]);const E=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",M=async()=>{if(!o||!c){alert("‚ö†Ô∏è Debes capturar al menos documento frontal y video.");return}if((r==="ci"||r==="licencia")&&!a){alert("‚ö†Ô∏è Debes capturar tambi√©n el reverso.");return}if(!(w&&(!a||L)&&k)){alert("‚ö†Ô∏è Espera a que todos los recursos se carguen completamente.");return}try{j(!0),d(null),g([]);const s=new FormData;s.append("carnet",o,"documento_frente.jpg"),a&&s.append("carnet_back",a,"documento_reverso.jpg"),s.append("doc_type",r),s.append("video",c,"video.mp4");const n=await _.post("/kyc-proxy-mobile",s,{headers:{"Content-Type":"multipart/form-data"}});y(n.data);const x=E(),u=new FormData;u.append("doc_type",r),u.append("docFront",o,"documento_frente.jpg"),a&&u.append("docBack",a,"documento_reverso.jpg"),u.append("video",c,"video.mp4"),u.append("resultado",JSON.stringify(n.data));const V=new URLSearchParams(window.location.search).get("token");V&&u.append("token",V);const i=(await _.post("/mobile-face-verify",u,{headers:{"X-CSRF-TOKEN":x}})).data;d(i.mensaje||"‚ÑπÔ∏è Verificaci√≥n realizada."),g(i.sugerencias||[]),S&&(i.status==="success"||i.kyc_status==="active")&&(S({status:i.status||i.kyc_status,mensaje:i.mensaje,sugerencias:i.sugerencias,kyc:n.data}),alert(`‚úÖ Verificaci√≥n completada correctamente.

Por favor, vuelve a la app para continuar.`),setTimeout(()=>{window.close()},500))}catch(s){console.error("‚ùå Error en verificaci√≥n:",s),s.response?.status===422?(d("‚ö†Ô∏è Datos inv√°lidos: revisa los campos requeridos."),g(s.response.data?.errors||[])):s.response?.data?.mensaje?d("‚ùå "+s.response.data.mensaje):d("‚ùå Error inesperado en la verificaci√≥n KYC.")}finally{j(!1)}},F=()=>l?e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-gray-100 shadow-inner space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Resultado de verificaci√≥n"}),N&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"üì¢ Mensaje:"})," ",N]}),l.score!==void 0&&e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"‚≠ê Score:"})," ",l.score]}),R.length>0&&e.jsxs("div",{children:[e.jsx("strong",{className:"text-sm",children:"‚ö†Ô∏è Sugerencias:"}),e.jsx("ul",{className:"list-disc ml-5 text-sm text-red-600",children:R.map((s,n)=>e.jsx("li",{children:s},`problem-${n}`))})]}),e.jsxs("details",{className:"mt-3",children:[e.jsx("summary",{className:"cursor-pointer text-xs text-gray-500",children:"Ver JSON completo"}),e.jsx("pre",{className:"text-xs bg-white rounded-md p-2 overflow-auto max-h-60 border",children:JSON.stringify(l,null,2)},JSON.stringify(l))]})]}):null;return e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 space-y-4",children:[e.jsx("p",{className:"font-semibold text-lg text-center",children:"Revisa tus capturas"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[h&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:r==="pasaporte"?"Pasaporte":"Anverso"}),e.jsx("img",{src:h,alt:"Documento anverso",onLoad:()=>D(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),m&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Reverso"}),e.jsx("img",{src:m,alt:"Documento reverso",onLoad:()=>C(!0),className:"rounded-lg border shadow w-full h-auto object-cover opacity-80"})]})]}),U&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Video selfie"}),e.jsx("video",{src:U,controls:!0,onLoadedData:()=>O(!0),className:"rounded-lg border shadow w-full h-auto object-cover"})]}),!w||a&&!L||!k?e.jsx("p",{className:"text-center text-sm text-gray-500 mt-2",children:"‚è≥ Cargando recursos..."}):null,e.jsxs("div",{className:"flex flex-wrap justify-center gap-3 mt-4",children:[e.jsx("button",{onClick:b,className:"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg",children:"Atr√°s"}),e.jsxs("button",{onClick:M,disabled:f||!(w&&(!a||L)&&k),className:"bg-purple-600 hover:bg-purple-700 disabled:opacity-60 text-white px-4 py-2 rounded-lg flex items-center gap-2",children:[f&&e.jsx(T,{className:"h-4 w-4 animate-spin"})," Verificar"]})]}),F()]})}function Q(){const[r,o]=t.useState(1),[a,c]=t.useState("ci"),[b,f]=t.useState(null),[j,l]=t.useState(null),[y,S]=t.useState(null),[N,d]=t.useState(!1),[R,g]=t.useState(null),h=4,v=()=>o(p=>Math.min(p+1,h)),m=()=>{o(p=>(p===2&&(f(null),l(null)),Math.max(p-1,1)))};return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-indigo-50 to-purple-50 space-y-6",children:e.jsxs("div",{className:"w-full max-w-3xl",children:[e.jsx(J,{step:r,totalSteps:h,labels:["Documento","Captura","Video","Revisi√≥n"]}),r===1&&e.jsx(K,{value:a,onChange:c,onNext:v}),r===2&&e.jsx(q,{docType:a,docFrontBlob:b,docBackBlob:j,setDocFrontBlob:f,setDocBackBlob:l,onNext:v,onBack:m}),r===3&&e.jsx(A,{videoBlob:y,setVideoBlob:S,nextStep:v,prevStep:m}),r===4&&e.jsx(z,{docType:a,docFrontBlob:b,docBackBlob:j,videoBlob:y,prevStep:m,loading:N,setLoading:d,resultado:R,setResultado:g})]})})}export{Q as default};
